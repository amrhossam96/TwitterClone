name: iOS Build and Test with SonarCloud

on:
  push:
    branches:
      - staging

  workflow_dispatch:

jobs:
  build:
    runs-on: macOS-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -switch /Applications/Xcode_13.0.app && /usr/bin/xcodebuild -version
    - name: Run tests
      run: xcodebuild test -scheme TwitterClone -project TwitterClone.xcodeproj -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.0' | xcpretty && exit ${PIPESTATUS[0]}

  
    - name: Generate Code Coverage
      run: |
        xcrun xccov view --json Report.xcresult > coverage.json

    - name: SonarCloud Analysis
      run: |
        curl -o sonar-scanner.zip -L https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-macosx.zip
        unzip -o sonar-scanner.zip
        export PATH=$PATH:$(pwd)/sonar-scanner-4.6.2.2472-macosx/bin

        sonar-scanner \
          -Dsonar.projectKey=amrhossam96_TwitterClone \
          -Dsonar.organization=amrhossam96 \
          -Dsonar.sources=. \
          -Dsonar.tests=. \
          -Dsonar.test.inclusions=**/*.swift \
          -Dsonar.coverageReportPaths=coverage.json \
          -Dsonar.swift.coverage.reportPaths=coverage.json \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
